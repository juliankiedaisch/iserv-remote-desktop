# Simplified Apache Configuration for IServ Remote Desktop
# 
# This configuration has been simplified with an internal nginx proxy handling
# routing logic. Apache now only needs to:
# 1. Handle SSL/TLS termination
# 2. Proxy all requests to the nginx service on port 8080
#
# The nginx proxy (in docker-compose) handles:
# - Backend API routing (/api, /ws)
# - Frontend routing (/)
# - VNC container subdomain routing (desktop-*.hub.mdg-hamburg.de)

<VirtualHost *:443>
    ServerName desktop.hub.mdg-hamburg.de
    # Support desktop-* subdomains for container routing (matches *.hub.mdg-hamburg.de SSL cert)
    ServerAlias desktop-*.hub.mdg-hamburg.de

    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/hub.combined
    SSLCertificateKeyFile /etc/ssl/private/hub.key

    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on
    
    # SSL Proxy settings for connecting to backend nginx
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
    
    # Forward proper headers for OAuth and session management
    ProxyPreserveHost On
    ProxyPassReverseCookiePath / /
    ProxyPassReverseCookieDomain localhost desktop.hub.mdg-hamburg.de
    
    # Increase timeouts for long-running desktop connections
    Timeout 3600
    ProxyTimeout 3600

    # Keep-alive settings for better connection handling
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5

    # Simple proxy to internal nginx service
    # Nginx handles all routing logic (main domain, subdomains, API, WebSocket)
    # Replace 172.22.0.27 with your Docker host IP
    ProxyPass / http://172.22.0.27:8080/ upgrade=any
    ProxyPassReverse / http://172.22.0.27:8080/

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/desktop_error.log
    CustomLog ${APACHE_LOG_DIR}/desktop_access.log combined
</VirtualHost>

<VirtualHost *:80>
    ServerName desktop.hub.mdg-hamburg.de
    # Support desktop-* subdomains for container routing
    ServerAlias desktop-*.hub.mdg-hamburg.de
    
    # Redirect to HTTPS with the same hostname (preserves subdomain)
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>
