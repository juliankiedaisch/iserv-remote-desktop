# Apache Reverse Proxy Configuration for IServ Remote Desktop
# This configuration handles WebSocket proxying and SSL termination for the application
#
# IMPORTANT: Replace ALL occurrences of 'your-domain.com' with your actual domain name
# IMPORTANT: Update SSL certificate paths to point to your actual certificate files

# Enable required Apache modules:
# sudo a2enmod proxy proxy_http proxy_wstunnel rewrite ssl headers

<VirtualHost *:443>
    ServerName your-domain.com
    
    # SSL Configuration
    # IMPORTANT: Update these paths to your actual certificate files
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    # If you have intermediate certificates:
    # SSLCertificateChainFile /path/to/intermediate.crt
    
    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on
    
    # Proxy settings for Flask application on port 5020
    ProxyPreserveHost On
    
    # Increase timeouts for long-running desktop connections
    # This is critical for containers that may take time to start
    Timeout 3600
    ProxyTimeout 3600
    
    # Keep-alive settings for better connection handling
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5
    
    # WebSocket support - CRITICAL for noVNC
    # This must come BEFORE the general proxy rules
    RewriteEngine On
    
    # Handle WebSocket connections with proper upgrade headers
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteCond %{HTTP:Connection} =upgrade [NC]
    RewriteRule /(.*)           ws://localhost:5020/$1 [P,L]
    
    # Handle normal HTTP requests
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           http://localhost:5020/$1 [P,L]
    
    # General proxy for all routes with WebSocket upgrade support
    ProxyPass / http://localhost:5020/ retry=3 timeout=3600 upgrade=websocket
    ProxyPassReverse / http://localhost:5020/
    
    # WebSocket-specific headers
    # These ensure proper WebSocket proxying through Apache to Flask
    RequestHeader set Connection "upgrade"
    RequestHeader set Upgrade "websocket"
    
    # Headers for proper proxying
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/iserv-remote-desktop-error.log
    CustomLog ${APACHE_LOG_DIR}/iserv-remote-desktop-access.log combined
</VirtualHost>

# Optional: Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName your-domain.com
    
    # Redirect all HTTP traffic to HTTPS
    Redirect permanent / https://your-domain.com/
</VirtualHost>
