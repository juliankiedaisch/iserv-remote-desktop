<VirtualHost *:443>
    ServerName desktop.hub.mdg-hamburg.de
    # Support desktop-* subdomains for container routing (matches *.hub.mdg-hamburg.de SSL cert)
    ServerAlias desktop-*.hub.mdg-hamburg.de

    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/hub.combined
    SSLCertificateKeyFile /etc/ssl/private/hub.key

    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on
    
    # SSL Proxy settings for connecting to containers with self-signed certificates
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
    
    # Forward proper headers for OAuth and session management
    ProxyPreserveHost On
    ProxyPassReverseCookiePath / /
    ProxyPassReverseCookieDomain localhost desktop.hub.mdg-hamburg.de
    
    # Increase timeouts for long-running desktop connections
    # This is critical for containers that may take time to start
    Timeout 3600
    ProxyTimeout 3600

    # Keep-alive settings for better connection handling
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5

    # WebSocket support - Dynamic subdomain routing to containers
    # Pattern: desktop-{container-name}.hub.mdg-hamburg.de â†’ container
    # This format matches wildcard SSL cert *.hub.mdg-hamburg.de
    # Uses RewriteMap to look up container IP:port from Flask API
    RewriteEngine On
    
    # Look up container target dynamically via external script
    RewriteMap containermap "prg:/opt/desktop.hub/get_container_target.py"
    
    # Skip main domain - let ProxyPass handle it
    RewriteCond %{HTTP_HOST} ^desktop\.hub\.mdg-hamburg\.de$ [NC]
    RewriteRule .* - [S=4]
    
    # Only process desktop-* subdomains
    RewriteCond %{HTTP_HOST} ^desktop-(.+)\.hub\.mdg-hamburg\.de$ [NC]
    # Get container target from RewriteMap
    RewriteCond ${containermap:%{HTTP_HOST}} !^NULL$
    # WebSocket upgrade requests - use wss:// protocol
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/(.*)$ wss://${containermap:%{HTTP_HOST}}/$1 [P,L]
    
    # Regular HTTPS requests to containers
    RewriteCond %{HTTP_HOST} ^desktop-(.+)\.hub\.mdg-hamburg\.de$ [NC]
    RewriteCond ${containermap:%{HTTP_HOST}} !^NULL$
    RewriteRule ^/(.*)$ https://${containermap:%{HTTP_HOST}}/$1 [P,L]
    
    # If container not found (NULL), redirect to main domain for authentication
    RewriteCond %{HTTP_HOST} ^desktop-(.+)\.hub\.mdg-hamburg\.de$ [NC]
    RewriteRule ^/(.*)$ https://desktop.hub.mdg-hamburg.de/ [R=302,L]
    
    # Inject KasmVNC Basic Auth credentials for container subdomains
    # This allows seamless access without prompting users for credentials
    <If "%{HTTP_HOST} =~ /^desktop-.*\.hub\.mdg-hamburg\.de$/">
        RequestHeader set Authorization "Basic a2FzbV91c2VyOnBhc3N3b3Jk"
    </If>
    
    # General HTTP proxy - handles both regular HTTP and WebSocket upgrades
    ProxyPass / http://172.22.0.27:5020/ upgrade=any
    ProxyPassReverse / http://172.22.0.27:5020/

    # Headers for proper proxying
#    RequestHeader set X-Forwarded-Proto "https"
#    RequestHeader set X-Forwarded-Port "443"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/desktop_error.log
    CustomLog ${APACHE_LOG_DIR}/desktop_access.log combined
</VirtualHost>

<VirtualHost *:80>
    ServerName desktop.hub.mdg-hamburg.de
    # Support desktop-* subdomains for container routing
    ServerAlias desktop-*.hub.mdg-hamburg.de
    
    # Redirect to HTTPS with the same hostname (preserves subdomain)
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>
