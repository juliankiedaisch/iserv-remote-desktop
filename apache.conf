# Apache Reverse Proxy Configuration for IServ Remote Desktop
# This configuration handles WebSocket proxying and SSL termination for the application
#
# IMPORTANT: Replace ALL occurrences of 'your-domain.com' with your actual domain name
# IMPORTANT: Update SSL certificate paths to point to your actual certificate files

# Enable required Apache modules:
# sudo a2enmod proxy proxy_http proxy_wstunnel rewrite ssl headers

<VirtualHost *:443>
    ServerName your-domain.com
    
    # SSL Configuration
    # IMPORTANT: Update these paths to your actual certificate files
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    # If you have intermediate certificates:
    # SSLCertificateChainFile /path/to/intermediate.crt
    
    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on
    
    # Proxy settings for Flask application on port 5020
    ProxyPreserveHost On
    
    # Increase timeouts for long-running desktop connections
    # This is critical for containers that may take time to start
    Timeout 3600
    ProxyTimeout 3600
    
    # Keep-alive settings for better connection handling
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5
    
    # WebSocket support - CRITICAL for noVNC
    # We need to preserve the Upgrade and Connection headers for Flask's gevent-websocket
    # to detect and handle WebSocket upgrade requests for container routing
    #
    # Note: We do NOT use ProxyPass with ws:// or upgrade=websocket because:
    # 1. It would make Apache handle the WebSocket upgrade itself
    # 2. Flask needs to inspect the Referer and session headers for routing  
    # 3. gevent-websocket needs to see the original WebSocket upgrade request
    #
    # Solution: Use SetEnvIf to detect WebSocket requests and conditionally set headers
    
    # Detect WebSocket upgrade requests and set an environment variable
    SetEnvIf Upgrade "(?i)websocket" IS_WEBSOCKET=1
    SetEnvIf Connection "(?i)upgrade" IS_UPGRADE=1
    
    # Preserve WebSocket headers for requests that have them
    # mod_proxy strips hop-by-hop headers by default, but we need them for Flask
    RequestHeader set Upgrade "websocket" env=IS_WEBSOCKET
    RequestHeader set Connection "Upgrade" env=IS_UPGRADE
    
    # General proxy for all routes (HTTP and WebSocket)
    ProxyPass / http://localhost:5020/ retry=3 timeout=3600
    ProxyPassReverse / http://localhost:5020/
    
    # Headers for proper proxying
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/iserv-remote-desktop-error.log
    CustomLog ${APACHE_LOG_DIR}/iserv-remote-desktop-access.log combined
</VirtualHost>

# Optional: Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName your-domain.com
    
    # Redirect all HTTP traffic to HTTPS
    Redirect permanent / https://your-domain.com/
</VirtualHost>
