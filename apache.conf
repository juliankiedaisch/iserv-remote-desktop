# Apache Reverse Proxy Configuration for IServ Remote Desktop
# This configuration handles WebSocket proxying and SSL termination for the application
#
# IMPORTANT: Replace ALL occurrences of 'your-domain.com' with your actual domain name
# IMPORTANT: Update SSL certificate paths to point to your actual certificate files

# Enable required Apache modules:
# sudo a2enmod proxy proxy_http proxy_wstunnel rewrite ssl headers

<VirtualHost *:443>
    ServerName your-domain.com
    
    # SSL Configuration
    # IMPORTANT: Update these paths to your actual certificate files
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    # If you have intermediate certificates:
    # SSLCertificateChainFile /path/to/intermediate.crt
    
    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on
    
    # Proxy settings for Flask application on port 5020
    ProxyPreserveHost On
    
    # Increase timeouts for long-running desktop connections
    # This is critical for containers that may take time to start
    Timeout 3600
    ProxyTimeout 3600
    
    # Keep-alive settings for better connection handling
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5
    
    # WebSocket support - CRITICAL for noVNC
    # DO NOT use upgrade=websocket in ProxyPass as it causes Apache to handle the upgrade
    # itself and prevents Flask from receiving the original HTTP upgrade request.
    # Flask needs to see the upgrade request to inspect Referer/session headers for routing.
    
    # RewriteRule handles WebSocket upgrade requests by passing them to Flask as-is
    # Flask's gevent-websocket will see the Upgrade header and handle the upgrade
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*) http://localhost:5020/$1 [P,L]
    
    # General proxy for all non-WebSocket HTTP routes
    # DO NOT add upgrade=websocket here - it breaks Flask's WebSocket handling
    ProxyPass / http://localhost:5020/ retry=3 timeout=3600
    ProxyPassReverse / http://localhost:5020/
    
    # Headers for proper proxying
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/iserv-remote-desktop-error.log
    CustomLog ${APACHE_LOG_DIR}/iserv-remote-desktop-access.log combined
</VirtualHost>

# Optional: Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName your-domain.com
    
    # Redirect all HTTP traffic to HTTPS
    Redirect permanent / https://your-domain.com/
</VirtualHost>
