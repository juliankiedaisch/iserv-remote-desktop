{% extends "base.html" %}

{% block title %}Remote Desktop - Select Desktop{% endblock %}

{% block extra_css %}
<style>
    .desktop-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .desktop-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.3s;
        position: relative;
    }
    
    .desktop-card:hover {
        box-shadow: 0 8px 12px rgba(0,0,0,0.15);
    }
    
    .desktop-card.running {
        border: 2px solid #28a745;
    }
    
    .desktop-card.stopped {
        border: 2px solid #6c757d;
    }
    
    .desktop-icon {
        font-size: 48px;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .desktop-name {
        font-size: 20px;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
        text-align: center;
    }
    
    .desktop-description {
        font-size: 14px;
        color: #666;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .desktop-status {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 10px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    
    .status-indicator.running {
        background: #28a745;
        animation: pulse 2s infinite;
    }
    
    .status-indicator.stopped {
        background: #6c757d;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .desktop-meta {
        font-size: 12px;
        color: #999;
        text-align: center;
        margin-top: 10px;
    }
    
    .desktop-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
    }
    
    .desktop-actions .btn {
        flex: 1;
        padding: 10px;
        font-size: 14px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
    }
    
    .desktop-actions .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .desktop-actions .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }
    
    .desktop-actions .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .desktop-actions .btn-danger:hover {
        background: #c82333;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: white;
        font-size: 18px;
    }
    
    .error-message {
        background: white;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>üñ•Ô∏è Remote Desktop</h1>
    <div class="user-info">
        <span class="username" id="username">Loading...</span>
        {% if is_admin %}
        <a href="/admin" class="admin-icon" title="Admin Panel">‚öôÔ∏è</a>
        {% endif %}
        <button class="btn btn-secondary" onclick="logout()">Logout</button>
    </div>
</div>

<div id="error-container"></div>

<div id="loading" class="loading">
    <p>Loading desktops...</p>
</div>

<div id="desktop-container" style="display: none;">
    <div class="desktop-grid" id="desktop-grid">
        <!-- Desktop cards will be inserted here -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const API_BASE = window.location.origin + '/api';
    let sessionId = localStorage.getItem('session_id');
    let userData = null;
    let availableDesktopTypes = [];
    
    async function checkSession() {
        if (!sessionId) {
            window.location.href = '/login';
            return false;
        }
        
        try {
            const response = await fetch(`/session?session_id=${sessionId}`);
            const data = await response.json();
            
            if (!data.authenticated) {
                localStorage.removeItem('session_id');
                window.location.href = '/login';
                return false;
            }
            
            userData = data.user;
            document.getElementById('username').textContent = userData.username;
            
            return true;
        } catch (error) {
            console.error('Session check failed:', error);
            showError('Failed to validate session');
            return false;
        }
    }
    
    async function loadAvailableDesktopTypes() {
        try {
            const response = await fetch(`${API_BASE}/container/available-types`, {
                headers: {
                    'X-Session-ID': sessionId
                }
            });
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to load desktop types');
            }
            
            availableDesktopTypes = data.desktop_types || [];
            
            // If no types available in database, fall back to hardcoded for backward compatibility
            if (availableDesktopTypes.length === 0) {
                availableDesktopTypes = [
                    {
                        name: 'ubuntu-vscode',
                        docker_image: 'kasmweb/vs-code:1.18.0',
                        description: 'Full Ubuntu desktop with Visual Studio Code pre-installed',
                        icon: 'üíª'
                    },
                    {
                        name: 'ubuntu-desktop',
                        docker_image: 'kasmweb/ubuntu-noble-desktop:1.18.0',
                        description: 'Standard Ubuntu desktop environment',
                        icon: 'üñ•Ô∏è'
                    }
                ];
            }
            
        } catch (error) {
            console.error('Failed to load desktop types:', error);
            // Fall back to hardcoded types
            availableDesktopTypes = [
                {
                    name: 'ubuntu-vscode',
                    docker_image: 'kasmweb/vs-code:1.18.0',
                    description: 'Full Ubuntu desktop with Visual Studio Code pre-installed',
                    icon: 'üíª'
                },
                {
                    name: 'ubuntu-desktop',
                    docker_image: 'kasmweb/ubuntu-noble-desktop:1.18.0',
                    description: 'Standard Ubuntu desktop environment',
                    icon: 'üñ•Ô∏è'
                }
            ];
        }
    }
    
    async function loadDesktops() {
        try {
            // Get all user's containers
            const response = await fetch(`${API_BASE}/container/list`, {
                headers: {
                    'X-Session-ID': sessionId
                }
            });
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to load desktops');
            }
            
            renderDesktops(data.containers || []);
            
        } catch (error) {
            console.error('Failed to load desktops:', error);
            showError('Failed to load desktops: ' + error.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('desktop-container').style.display = 'block';
        }
    }
    
    function renderDesktops(containers) {
        const grid = document.getElementById('desktop-grid');
        grid.innerHTML = '';
        
        // Create a map of containers by desktop type name
        const containerMap = {};
        containers.forEach(container => {
            if (container.desktop_type) {
                containerMap[container.desktop_type] = container;
            }
        });
        
        // Render available desktop types
        availableDesktopTypes.forEach(desktop => {
            const card = createDesktopCard(desktop, containerMap);
            grid.appendChild(card);
        });
        
        // Show message if no desktop types available
        if (availableDesktopTypes.length === 0) {
            grid.innerHTML = '<div class="error-message">No desktop types available for your account</div>';
        }
    }
    
    function createDesktopCard(desktop, containerMap) {
        // Find matching container by desktop type name
        const container = containerMap[desktop.name];
        
        const isRunning = container && container.status === 'running';
        
        const card = document.createElement('div');
        card.className = `desktop-card ${isRunning ? 'running' : 'stopped'}`;
        
        let lastAccessText = '';
        if (container && container.last_accessed) {
            const lastAccess = new Date(container.last_accessed);
            lastAccessText = `Last accessed: ${formatRelativeTime(lastAccess)}`;
        }
        
        card.innerHTML = `
            <div class="desktop-icon">${desktop.icon || 'üñ•Ô∏è'}</div>
            <div class="desktop-name">${desktop.name}</div>
            <div class="desktop-description">${desktop.description || ''}</div>
            <div class="desktop-status">
                <span class="status-indicator ${isRunning ? 'running' : 'stopped'}"></span>
                <span>${isRunning ? 'Running' : 'Stopped'}</span>
            </div>
            ${lastAccessText ? `<div class="desktop-meta">${lastAccessText}</div>` : ''}
            <div class="desktop-actions">
                ${isRunning ? 
                    `<button class="btn btn-primary" onclick="event.stopPropagation(); openDesktop('${container.url}');">Open</button>
                     <button class="btn btn-danger" onclick="event.stopPropagation(); stopContainer('${desktop.name}');">Stop</button>` :
                    `<button class="btn btn-primary" onclick="event.stopPropagation(); startDesktop('${desktop.name}');">Start</button>`
                }
            </div>
        `;
        
        return card;
    }
    
    async function openDesktop(url) {
        window.open(url, '_blank');
        await updateLastAccess();
    }
    
    async function startDesktop(desktopType) {
        try {
            showLoading('Creating container...');
            
            const response = await fetch(`${API_BASE}/container/start?desktop_type=${desktopType}`, {
                method: 'POST',
                headers: {
                    'X-Session-ID': sessionId
                }
            });
            
            const data = await response.json();
            
            if (data.success && data.url) {
                // Reload to show updated status
                showLoading('Container created, starting services...');
                await loadDesktops();
                
                // Give container initial time to start up (3 seconds)
                // This allows Docker to initialize the container before we start polling
                for (let i = 3; i > 0; i--) {
                    showLoading(`Initializing services... (${i}s)`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                // Now poll for container readiness
                showLoading('Checking if desktop is ready...');
                
                const maxAttempts = 25; // 25 more attempts after initial 3s wait
                let attempts = 0;
                let ready = false;
                
                while (attempts < maxAttempts && !ready) {
                    attempts++;
                    
                    // Update status message with progress
                    const dots = '.'.repeat((attempts % 3) + 1);
                    showLoading(`Waiting for desktop to be ready${dots} (${attempts + 3}s)`);
                    
                    try {
                        const healthResponse = await fetch(
                            `${API_BASE}/container/health?desktop_type=${encodeURIComponent(desktopType)}`, 
                            {
                                headers: {
                                    'X-Session-ID': sessionId
                                }
                            }
                        );
                        
                        const healthData = await healthResponse.json();
                        
                        if (healthData.success && healthData.ready) {
                            // Add small additional delay to ensure VNC server is fully ready
                            showLoading('Desktop ready, preparing to open...');
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            ready = true;
                            break;
                        }
                    } catch (healthError) {
                        console.log('Health check attempt', attempts, 'failed:', healthError.message);
                    }
                    
                    // Wait 1 second before next check
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                if (ready) {
                    showLoading('Opening desktop...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                    window.open(data.url, '_blank');
                    
                    showLoading('Desktop opened in new tab');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } else {
                    // Timeout - open anyway but warn user
                    window.open(data.url, '_blank');
                    showError('Desktop is starting but may take a few more seconds to load. Please refresh the tab if needed.');
                }
            } else {
                throw new Error(data.error || 'Failed to start desktop');
            }
            
        } catch (error) {
            console.error('Failed to start desktop:', error);
            showError('Failed to start desktop: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function stopContainer(desktopType) {
        if (!confirm(`Are you sure you want to stop the ${desktopType} container?`)) {
            return;
        }
        
        try {
            showLoading('Stopping container...');
            
            const response = await fetch(`${API_BASE}/container/stop`, {
                method: 'POST',
                headers: {
                    'X-Session-ID': sessionId,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    desktop_type: desktopType
                })
            });
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to stop container');
            }
            
            // Reload desktops to reflect the change
            await loadDesktops();
            
        } catch (error) {
            console.error('Failed to stop container:', error);
            showError('Failed to stop container: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function updateLastAccess() {
        // Reload desktops to update last access time
        await loadDesktops();
    }
    
    function formatRelativeTime(date) {
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        
        if (seconds < 60) return 'just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
        return Math.floor(seconds / 86400) + ' days ago';
    }
    
    function showError(message) {
        const container = document.getElementById('error-container');
        container.innerHTML = `
            <div class="alert alert-error">
                <strong>Error:</strong> ${message}
            </div>
        `;
    }
    
    function showLoading(message) {
        const loadingEl = document.getElementById('loading');
        loadingEl.style.display = 'block';
        if (message !== undefined) {
            loadingEl.querySelector('p').textContent = message;
        }
    }
    
    function hideLoading() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('loading').querySelector('p').textContent = 'Loading desktops...';
    }
    
    async function logout() {
        try {
            await fetch('/logout', {
                method: 'POST',
                headers: {
                    'X-Session-ID': sessionId
                }
            });
        } catch (error) {
            console.error('Logout error:', error);
        }
        
        localStorage.removeItem('session_id');
        window.location.href = '/login';
    }
    
    // Initialize
    async function init() {
        const authenticated = await checkSession();
        if (authenticated) {
            await loadAvailableDesktopTypes();
            await loadDesktops();
            
            // Refresh desktop status every 30 seconds to show current state
            // Balance between responsiveness and server load
            setInterval(loadDesktops, 30000);
        }
    }
    
    init();
</script>
{% endblock %}
