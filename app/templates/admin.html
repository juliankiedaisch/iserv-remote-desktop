{% extends "base.html" %}

{% block title %}Admin Panel - Remote Desktop{% endblock %}

{% block extra_css %}
<style>
    .admin-container {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #eee;
    }
    
    .admin-header h2 {
        color: #333;
        font-size: 28px;
    }
    
    .admin-actions {
        display: flex;
        gap: 10px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }
    
    .stat-card .stat-value {
        font-size: 36px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-card .stat-label {
        font-size: 14px;
        opacity: 0.9;
    }
    
    .container-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .container-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #dee2e6;
    }
    
    .container-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
        color: #666;
    }
    
    .container-table tr:hover {
        background: #f8f9fa;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .status-badge.running {
        background: #d4edda;
        color: #155724;
    }
    
    .status-badge.stopped {
        background: #f8d7da;
        color: #721c24;
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .loading-overlay.active {
        display: flex;
    }
    
    .loading-spinner {
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }
    
    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>‚öôÔ∏è Admin Panel</h1>
    <div class="user-info">
        <span class="username" id="username">Loading...</span>
        <a href="/" class="btn btn-secondary">‚Üê Back to Desktops</a>
        <button class="btn btn-secondary" onclick="logout()">Logout</button>
    </div>
</div>

<div id="error-container"></div>

<div class="admin-container">
    <div class="admin-header">
        <h2>Container Management</h2>
        <div class="admin-actions">
            <button class="btn btn-primary" onclick="refreshContainers()">üîÑ Refresh</button>
            <button class="btn btn-danger" onclick="stopAllContainers()">‚èπÔ∏è Stop All</button>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="total-containers">0</div>
            <div class="stat-label">Total Containers</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="running-containers">0</div>
            <div class="stat-label">Running</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="active-users">0</div>
            <div class="stat-label">Active Users</div>
        </div>
    </div>
    
    <div id="container-list">
        <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <p>Loading containers...</p>
        </div>
    </div>
</div>

<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner">
        <p>Processing...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const API_BASE = window.location.origin + '/api';
    let sessionId = localStorage.getItem('session_id');
    let userData = null;
    
    async function checkSession() {
        if (!sessionId) {
            window.location.href = '/login';
            return false;
        }
        
        try {
            const response = await fetch(`/session?session_id=${sessionId}`);
            const data = await response.json();
            
            if (!data.authenticated) {
                localStorage.removeItem('session_id');
                window.location.href = '/login';
                return false;
            }
            
            userData = data.user;
            
            // Check if user is admin
            if (userData.role !== 'admin') {
                window.location.href = '/';
                return false;
            }
            
            document.getElementById('username').textContent = userData.username + ' (Admin)';
            return true;
            
        } catch (error) {
            console.error('Session check failed:', error);
            showError('Failed to validate session');
            return false;
        }
    }
    
    async function loadAllContainers() {
        try {
            const response = await fetch(`${API_BASE}/admin/containers`, {
                headers: {
                    'X-Session-ID': sessionId
                }
            });
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to load containers');
            }
            
            renderContainers(data.containers || []);
            updateStats(data.containers || []);
            
        } catch (error) {
            console.error('Failed to load containers:', error);
            showError('Failed to load containers: ' + error.message);
        }
    }
    
    function updateStats(containers) {
        const total = containers.length;
        const running = containers.filter(c => c.status === 'running').length;
        const users = new Set(containers.map(c => c.user_id)).size;
        
        document.getElementById('total-containers').textContent = total;
        document.getElementById('running-containers').textContent = running;
        document.getElementById('active-users').textContent = users;
    }
    
    function renderContainers(containers) {
        const containerList = document.getElementById('container-list');
        
        if (containers.length === 0) {
            containerList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <p>No containers found</p>
                </div>
            `;
            return;
        }
        
        let html = `
            <table class="container-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Container Name</th>
                        <th>Status</th>
                        <th>Port</th>
                        <th>Created</th>
                        <th>Last Accessed</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        containers.forEach(container => {
            html += `
                <tr>
                    <td><strong>${container.username || 'Unknown'}</strong></td>
                    <td>${container.container_name}</td>
                    <td>
                        <span class="status-badge ${container.status}">
                            ${container.status.toUpperCase()}
                        </span>
                    </td>
                    <td>${container.host_port || 'N/A'}</td>
                    <td>${formatDate(container.created_at)}</td>
                    <td>${formatDate(container.last_accessed)}</td>
                    <td>
                        <div class="action-buttons">
                            ${container.status === 'running' ? `
                                <button class="btn btn-sm btn-primary" onclick="openContainer('${container.url}')">
                                    Open
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="stopContainer('${container.id}', '${container.container_name}')">
                                    Stop
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="removeContainer('${container.id}', '${container.container_name}')">
                                Remove
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        containerList.innerHTML = html;
    }
    
    function openContainer(url) {
        if (url) {
            window.open(url, '_blank');
        }
    }
    
    async function stopContainer(containerId, containerName) {
        if (!confirm(`Stop container "${containerName}"?`)) {
            return;
        }
        
        showLoading();
        
        try {
            const response = await fetch(`${API_BASE}/admin/container/${containerId}/stop`, {
                method: 'POST',
                headers: {
                    'X-Session-ID': sessionId
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess('Container stopped successfully');
                await loadAllContainers();
            } else {
                throw new Error(data.error || 'Failed to stop container');
            }
            
        } catch (error) {
            console.error('Failed to stop container:', error);
            showError('Failed to stop container: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function removeContainer(containerId, containerName) {
        if (!confirm(`Remove container "${containerName}"? This action cannot be undone.`)) {
            return;
        }
        
        showLoading();
        
        try {
            const response = await fetch(`${API_BASE}/admin/container/${containerId}/remove`, {
                method: 'DELETE',
                headers: {
                    'X-Session-ID': sessionId
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess('Container removed successfully');
                await loadAllContainers();
            } else {
                throw new Error(data.error || 'Failed to remove container');
            }
            
        } catch (error) {
            console.error('Failed to remove container:', error);
            showError('Failed to remove container: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function stopAllContainers() {
        if (!confirm('Stop ALL running containers? This will affect all users!')) {
            return;
        }
        
        showLoading();
        
        try {
            const response = await fetch(`${API_BASE}/admin/containers/stop-all`, {
                method: 'POST',
                headers: {
                    'X-Session-ID': sessionId
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess(`Successfully stopped ${data.stopped_count} container(s)`);
                await loadAllContainers();
            } else {
                throw new Error(data.error || 'Failed to stop containers');
            }
            
        } catch (error) {
            console.error('Failed to stop all containers:', error);
            showError('Failed to stop all containers: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function refreshContainers() {
        showLoading();
        await loadAllContainers();
        hideLoading();
    }
    
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString();
    }
    
    function showError(message) {
        const container = document.getElementById('error-container');
        container.innerHTML = `
            <div class="alert alert-error">
                <strong>Error:</strong> ${message}
            </div>
        `;
        // Auto-dismiss error after 5 seconds to keep UI clean
        setTimeout(() => {
            container.innerHTML = '';
        }, 5000);
    }
    
    function showSuccess(message) {
        const container = document.getElementById('error-container');
        container.innerHTML = `
            <div class="alert alert-success">
                <strong>Success:</strong> ${message}
            </div>
        `;
        // Auto-dismiss success after 3 seconds (shorter than errors)
        setTimeout(() => {
            container.innerHTML = '';
        }, 3000);
    }
    
    function showLoading() {
        document.getElementById('loading-overlay').classList.add('active');
    }
    
    function hideLoading() {
        document.getElementById('loading-overlay').classList.remove('active');
    }
    
    async function logout() {
        try {
            await fetch('/logout', {
                method: 'POST',
                headers: {
                    'X-Session-ID': sessionId
                }
            });
        } catch (error) {
            console.error('Logout error:', error);
        }
        
        localStorage.removeItem('session_id');
        window.location.href = '/login';
    }
    
    // Initialize
    async function init() {
        const authenticated = await checkSession();
        if (authenticated) {
            await loadAllContainers();
            
            // Auto-refresh every 10 seconds for admin panel
            // More frequent than user view (30s) to quickly catch container state changes
            setInterval(loadAllContainers, 10000);
        }
    }
    
    init();
</script>
{% endblock %}
