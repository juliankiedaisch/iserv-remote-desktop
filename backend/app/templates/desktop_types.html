{% extends "base.html" %}

{% block title %}Desktop Types - Admin{% endblock %}

{% block extra_css %}
<style>
    .admin-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 2px solid #eee;
    }
    
    .admin-tab {
        padding: 12px 24px;
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        font-size: 16px;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
    }
    
    .admin-tab:hover {
        color: #333;
    }
    
    .admin-tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
    }
    
    .desktop-types-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .desktop-type-card {
        background: white;
        border: 2px solid #eee;
        border-radius: 10px;
        padding: 20px;
        transition: all 0.3s;
    }
    
    .desktop-type-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102,126,234,0.1);
    }
    
    .desktop-type-card.disabled {
        opacity: 0.6;
    }
    
    .desktop-type-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .desktop-type-icon {
        font-size: 48px;
        margin-bottom: 10px;
    }
    
    .desktop-type-name {
        font-size: 20px;
        font-weight: 600;
        color: #333;
    }
    
    .desktop-type-image {
        font-size: 12px;
        color: #999;
        margin: 5px 0;
        font-family: monospace;
    }
    
    .desktop-type-description {
        color: #666;
        margin: 10px 0;
    }
    
    .desktop-type-stats {
        display: flex;
        gap: 15px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
    }
    
    .stat {
        font-size: 12px;
        color: #666;
    }
    
    .stat strong {
        color: #333;
    }
    
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .modal.active {
        display: flex;
    }
    
    .modal-content {
        background: white;
        border-radius: 10px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .modal-header h3 {
        margin: 0;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }
    
    .form-group textarea {
        min-height: 80px;
        resize: vertical;
    }
    
    .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
    
    .assignment-list {
        list-style: none;
        padding: 0;
    }
    
    .assignment-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 10px;
    }
    
    .assignment-info {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .assignment-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .assignment-badge.group {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .assignment-badge.user {
        background: #f3e5f5;
        color: #7b1fa2;
    }
    
    .autocomplete-container {
        position: relative;
    }
    
    .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .autocomplete-list.active {
        display: block;
    }
    
    .autocomplete-item {
        padding: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .autocomplete-item:hover {
        background: #f8f9fa;
    }
    
    .autocomplete-item .icon {
        font-size: 16px;
    }
    
    .autocomplete-item .label {
        flex: 1;
        font-size: 14px;
    }
    
    .autocomplete-item .sublabel {
        font-size: 12px;
        color: #999;
    }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>üé® Desktop Types Management</h1>
    <div class="user-info">
        <span class="username" id="username">Loading...</span>
        <a href="/admin" class="btn btn-secondary">‚Üê Back to Admin</a>
        <button class="btn btn-secondary" onclick="logout()">Logout</button>
    </div>
</div>

<div id="error-container"></div>

<div class="admin-container">
    <div class="admin-header">
        <h2>Manage Desktop Types & Assignments</h2>
        <button class="btn btn-primary" onclick="showCreateDesktopModal()">‚ûï Add Desktop Type</button>
    </div>
    
    <div id="desktop-types-container">
        <div class="empty-state">
            <div class="empty-state-icon">üñ•Ô∏è</div>
            <p>Loading desktop types...</p>
        </div>
    </div>
</div>

<!-- Create/Edit Desktop Type Modal -->
<div class="modal" id="desktop-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Add Desktop Type</h3>
            <button class="modal-close" onclick="closeModal('desktop-modal')">&times;</button>
        </div>
        
        <form id="desktop-form" onsubmit="saveDesktopType(event)">
            <input type="hidden" id="desktop-id">
            
            <div class="form-group">
                <label for="desktop-name">Name *</label>
                <input type="text" id="desktop-name" required>
            </div>
            
            <div class="form-group">
                <label for="desktop-image">Docker Image *</label>
                <input type="text" id="desktop-image" placeholder="e.g., kasmweb/vs-code:1.16.0" required>
            </div>
            
            <div class="form-group">
                <label for="desktop-icon">Icon</label>
                <input type="text" id="desktop-icon" placeholder="e.g., üíª">
            </div>
            
            <div class="form-group">
                <label for="desktop-description">Description</label>
                <textarea id="desktop-description"></textarea>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="desktop-enabled" checked>
                    Enabled
                </label>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('desktop-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Assignments Modal -->
<div class="modal" id="assignments-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="assignments-title">Manage Assignments</h3>
            <button class="modal-close" onclick="closeModal('assignments-modal')">&times;</button>
        </div>
        
        <div class="form-group">
            <label>Add Assignment</label>
            <div style="display: flex; gap: 10px;">
                <select id="assignment-type" style="width: auto;" onchange="switchAssignmentType()">
                    <option value="group">Group</option>
                    <option value="user">User</option>
                </select>
                <div class="autocomplete-container" style="flex: 1; position: relative;">
                    <input type="text" 
                           id="assignment-value" 
                           placeholder="Type to search..." 
                           autocomplete="off"
                           oninput="filterAutocomplete()"
                           onfocus="showAutocomplete()"
                           style="width: 100%;">
                    <div id="autocomplete-list" class="autocomplete-list"></div>
                </div>
                <button class="btn btn-primary btn-sm" onclick="addAssignment()">Add</button>
            </div>
            <small>No assignments = available to all users</small>
        </div>
        
        <div id="assignments-list">
            <p>Loading assignments...</p>
        </div>
    </div>
</div>

<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner">
        <p>Processing...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const API_BASE = window.location.origin + '/api';
    let sessionId = localStorage.getItem('session_id');
    let currentDesktopTypeId = null;
    let availableGroups = [];
    let availableUsers = [];
    let autocompleteData = [];
    
    // Close autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-container')) {
            document.getElementById('autocomplete-list').classList.remove('active');
        }
    });
    
    async function checkSession() {
        if (!sessionId) {
            window.location.href = '/login';
            return false;
        }
        
        try {
            const response = await fetch(`/session?session_id=${sessionId}`);
            const data = await response.json();
            
            if (!data.authenticated || data.user.role !== 'admin') {
                window.location.href = '/';
                return false;
            }
            
            document.getElementById('username').textContent = data.user.username + ' (Admin)';
            return true;
        } catch (error) {
            console.error('Session check failed:', error);
            return false;
        }
    }
    
    async function loadDesktopTypes() {
        try {
            const response = await fetch(`${API_BASE}/admin/desktops/types`, {
                headers: {'X-Session-ID': sessionId}
            });
            
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    showError('Session expired or insufficient permissions');
                    setTimeout(() => window.location.href = '/login', 2000);
                    return;
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            if (!data.success) throw new Error(data.error);
            
            renderDesktopTypes(data.desktop_types || []);
        } catch (error) {
            console.error('Failed to load desktop types:', error);
            showError('Failed to load desktop types: ' + error.message);
        }
    }
    
    function renderDesktopTypes(types) {
        const container = document.getElementById('desktop-types-container');
        
        if (types.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üñ•Ô∏è</div>
                    <p>No desktop types configured</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `<div class="desktop-types-grid">${types.map(type => `
            <div class="desktop-type-card ${type.enabled ? '' : 'disabled'}">
                <div class="desktop-type-icon">${type.icon || 'üñ•Ô∏è'}</div>
                <div class="desktop-type-name">${type.name}</div>
                <div class="desktop-type-image">${type.docker_image}</div>
                <div class="desktop-type-description">${type.description || ''}</div>
                <div class="desktop-type-stats">
                    <div class="stat"><strong>${type.assignment_count}</strong> assignments</div>
                    <div class="stat">${type.enabled ? '‚úÖ Enabled' : '‚ùå Disabled'}</div>
                </div>
                <div class="action-buttons" style="margin-top: 15px;">
                    <button class="btn btn-sm btn-primary" onclick="showAssignmentsModal(${type.id}, '${type.name}')">Assignments</button>
                    <button class="btn btn-sm btn-secondary" onclick="editDesktopType(${type.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteDesktopType(${type.id}, '${type.name}')">Delete</button>
                </div>
            </div>
        `).join('')}</div>`;
    }
    
    function showCreateDesktopModal() {
        document.getElementById('modal-title').textContent = 'Add Desktop Type';
        document.getElementById('desktop-form').reset();
        document.getElementById('desktop-id').value = '';
        document.getElementById('desktop-enabled').checked = true;
        showModal('desktop-modal');
    }
    
    async function editDesktopType(id) {
        // Load desktop type details and populate form
        try {
            const response = await fetch(`${API_BASE}/admin/desktops/types`, {
                headers: {'X-Session-ID': sessionId}
            });
            const data = await response.json();
            const type = data.desktop_types.find(t => t.id === id);
            
            if (type) {
                document.getElementById('modal-title').textContent = 'Edit Desktop Type';
                document.getElementById('desktop-id').value = type.id;
                document.getElementById('desktop-name').value = type.name;
                document.getElementById('desktop-image').value = type.docker_image;
                document.getElementById('desktop-icon').value = type.icon || '';
                document.getElementById('desktop-description').value = type.description || '';
                document.getElementById('desktop-enabled').checked = type.enabled;
                showModal('desktop-modal');
            }
        } catch (error) {
            showError('Failed to load desktop type: ' + error.message);
        }
    }
    
    async function saveDesktopType(event) {
        event.preventDefault();
        showLoading();
        
        const id = document.getElementById('desktop-id').value;
        const data = {
            name: document.getElementById('desktop-name').value,
            docker_image: document.getElementById('desktop-image').value,
            icon: document.getElementById('desktop-icon').value || 'üñ•Ô∏è',
            description: document.getElementById('desktop-description').value,
            enabled: document.getElementById('desktop-enabled').checked
        };
        
        try {
            const url = id ? `${API_BASE}/admin/desktops/types/${id}` : `${API_BASE}/admin/desktops/types`;
            const method = id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-Session-ID': sessionId
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (!result.success) throw new Error(result.error);
            
            showSuccess(id ? 'Desktop type updated' : 'Desktop type created');
            closeModal('desktop-modal');
            await loadDesktopTypes();
        } catch (error) {
            showError('Failed to save: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function deleteDesktopType(id, name) {
        if (!confirm(`Delete desktop type "${name}"? This will remove all assignments.`)) return;
        
        showLoading();
        try {
            const response = await fetch(`${API_BASE}/admin/desktops/types/${id}`, {
                method: 'DELETE',
                headers: {'X-Session-ID': sessionId}
            });
            
            const result = await response.json();
            if (!result.success) throw new Error(result.error);
            
            showSuccess('Desktop type deleted');
            await loadDesktopTypes();
        } catch (error) {
            showError('Failed to delete: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function showAssignmentsModal(typeId, typeName) {
        currentDesktopTypeId = typeId;
        document.getElementById('assignments-title').textContent = `Assignments: ${typeName}`;
        showModal('assignments-modal');
        await loadAssignments(typeId);
    }
    
    async function loadAssignments(typeId) {
        try {
            const response = await fetch(`${API_BASE}/admin/desktops/types/${typeId}/assignments`, {
                headers: {'X-Session-ID': sessionId}
            });
            
            const data = await response.json();
            if (!data.success) throw new Error(data.error);
            
            renderAssignments(data.assignments || []);
        } catch (error) {
            document.getElementById('assignments-list').innerHTML = `<p>Error: ${error.message}</p>`;
        }
    }
    
    function renderAssignments(assignments) {
        const list = document.getElementById('assignments-list');
        
        if (assignments.length === 0) {
            list.innerHTML = '<p>No assignments - available to all users</p>';
            return;
        }
        
        list.innerHTML = `<ul class="assignment-list">${assignments.map(a => {
            const isGroup = !!a.group_name;
            const displayName = isGroup ? a.group_name : (a.username || a.user_id);
            
            return `
                <li class="assignment-item">
                    <div class="assignment-info">
                        <span class="assignment-badge ${isGroup ? 'group' : 'user'}">
                            ${isGroup ? 'üë• Group' : 'üë§ User'}
                        </span>
                        <span>${displayName}</span>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="deleteAssignment(${a.id})">Remove</button>
                </li>
            `;
        }).join('')}</ul>`;
    }
    
    async function addAssignment() {
        const type = document.getElementById('assignment-type').value;
        const input = document.getElementById('assignment-value');
        const displayValue = input.value.trim();
        
        // Use the stored actual value (ID) if available, otherwise use display value
        const actualValue = input.dataset.selectedValue || displayValue;
        
        if (!actualValue) {
            showError('Please enter a group name or user ID');
            return;
        }
        
        showLoading();
        try {
            const payload = type === 'group' 
                ? { group_name: actualValue }
                : { user_id: actualValue };
            
            const response = await fetch(`${API_BASE}/admin/desktops/types/${currentDesktopTypeId}/assignments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Session-ID': sessionId
                },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            if (!result.success) throw new Error(result.error);
            
            input.value = '';
            delete input.dataset.selectedValue;
            showSuccess('Assignment added');
            await loadAssignments(currentDesktopTypeId);
            await loadDesktopTypes();
        } catch (error) {
            showError('Failed to add assignment: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    async function deleteAssignment(id) {
        showLoading();
        try {
            const response = await fetch(`${API_BASE}/admin/desktops/assignments/${id}`, {
                method: 'DELETE',
                headers: {'X-Session-ID': sessionId}
            });
            
            const result = await response.json();
            if (!result.success) throw new Error(result.error);
            
            showSuccess('Assignment removed');
            await loadAssignments(currentDesktopTypeId);
            await loadDesktopTypes();
        } catch (error) {
            showError('Failed to remove assignment: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    function showModal(id) {
        document.getElementById(id).classList.add('active');
    }
    
    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }
    
    function showError(message) {
        document.getElementById('error-container').innerHTML = `
            <div class="alert alert-error"><strong>Error:</strong> ${message}</div>
        `;
        setTimeout(() => document.getElementById('error-container').innerHTML = '', 5000);
    }
    
    function showSuccess(message) {
        document.getElementById('error-container').innerHTML = `
            <div class="alert alert-success"><strong>Success:</strong> ${message}</div>
        `;
        setTimeout(() => document.getElementById('error-container').innerHTML = '', 3000);
    }
    
    function showLoading() {
        document.getElementById('loading-overlay').classList.add('active');
    }
    
    function hideLoading() {
        document.getElementById('loading-overlay').classList.remove('active');
    }
    
    async function logout() {
        localStorage.removeItem('session_id');
        window.location.href = '/login';
    }
    
    async function loadAvailableGroupsAndUsers() {
        try {
            // Load groups
            const groupsResponse = await fetch(`${API_BASE}/admin/desktops/available-groups`, {
                headers: {'X-Session-ID': sessionId}
            });
            const groupsData = await groupsResponse.json();
            if (groupsData.success) {
                availableGroups = groupsData.groups || [];
            }
            
            // Load users
            const usersResponse = await fetch(`${API_BASE}/admin/desktops/available-users`, {
                headers: {'X-Session-ID': sessionId}
            });
            const usersData = await usersResponse.json();
            if (usersData.success) {
                availableUsers = usersData.users || [];
            }
            
            // Initialize with groups
            switchAssignmentType();
        } catch (error) {
            console.error('Failed to load groups/users:', error);
        }
    }
    
    function switchAssignmentType() {
        const type = document.getElementById('assignment-type').value;
        const input = document.getElementById('assignment-value');
        
        if (type === 'group') {
            input.placeholder = 'Type to search groups...';
            autocompleteData = availableGroups.map(g => ({
                value: g,
                label: g,
                icon: 'üë•',
                type: 'group'
            }));
        } else {
            input.placeholder = 'Type to search users...';
            autocompleteData = availableUsers.map(u => ({
                value: u.id,
                label: u.username,
                sublabel: u.email || u.role,
                icon: 'üë§',
                type: 'user'
            }));
        }
        
        input.value = '';
        document.getElementById('autocomplete-list').classList.remove('active');
    }
    
    function showAutocomplete() {
        filterAutocomplete();
    }
    
    function filterAutocomplete() {
        const input = document.getElementById('assignment-value');
        const list = document.getElementById('autocomplete-list');
        const query = input.value.toLowerCase();
        
        const filtered = autocompleteData.filter(item => 
            item.label.toLowerCase().includes(query) ||
            (item.sublabel && item.sublabel.toLowerCase().includes(query))
        );
        
        if (filtered.length === 0) {
            list.innerHTML = '<div style="padding: 10px; color: #999;">No matches found</div>';
            list.classList.add('active');
            return;
        }
        
        list.innerHTML = filtered.map(item => `
            <div class="autocomplete-item" onclick="selectAutocomplete('${item.value.replace(/'/g, "\\'")}', '${item.label.replace(/'/g, "\\'")}')">
                <span class="icon">${item.icon}</span>
                <div style="flex: 1;">
                    <div class="label">${item.label}</div>
                    ${item.sublabel ? `<div class="sublabel">${item.sublabel}</div>` : ''}
                </div>
            </div>
        `).join('');
        
        list.classList.add('active');
    }
    
    function selectAutocomplete(value, label) {
        const input = document.getElementById('assignment-value');
        const type = document.getElementById('assignment-type').value;
        
        // Store the actual value (ID for users, name for groups)
        input.value = type === 'user' ? label : value;
        input.dataset.selectedValue = value;
        
        document.getElementById('autocomplete-list').classList.remove('active');
    }
    
    async function init() {
        if (await checkSession()) {
            await loadAvailableGroupsAndUsers();
            await loadDesktopTypes();
        }
    }
    
    init();
</script>
{% endblock %}
